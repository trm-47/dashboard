<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>DASHBOARD KTA - TRM47</title>
    <style>
        body { background: #000; color: #fff; font-family: 'Arial Black', Gadget, sans-serif; text-align: center; padding-top: 50px; }
        .card { border: 10px solid #cc0000; display: inline-block; padding: 40px; border-radius: 30px; background: #111; box-shadow: 0 0 40px #ff0000; min-width: 380px; }
        .foto { width: 300px; height: 300px; border: 5px solid #fff; margin: 0 auto 20px; background: #222; border-radius: 15px; overflow: hidden; }
        img { width: 100%; height: 100%; object-fit: cover; }
        h1 { color: #ff0000; font-size: 2.5em; margin: 10px 0; text-transform: uppercase; }
        .jabatan { color: #ffd700; font-size: 1.8em; font-weight: bold; border-bottom: 2px dashed #333; padding-bottom: 15px; }
        .kta { color: #888; font-size: 1.3em; margin-top: 20px; font-family: monospace; }
    </style>
</head>
<body>

    <div class="card">
        <div class="foto">
            <img id="displayFoto" src="" onerror="this.src='https://via.placeholder.com/300?text=FOTO+ANGGOTA'">
        </div>
        <h1 id="displayNama">MENUNGGU...</h1>
        <div id="displayJabatan" class="jabatan">-</div>
        <div id="displayKTA" class="kta">KTA: -</div>
    </div>

    <script>
    const ssID = '1Egbat36S6ZXP-x_bJNHVIQgJi26H-siDsY538_iGl_8';
    // Gunakan gviz tq tanpa parameter sheet jika nama sheetnya default, 
    // atau pastikan nama sheet 'Data_Anggota' benar-benar pas ejaannya.
    const url = `https://docs.google.com/spreadsheets/d/${ssID}/gviz/tq?tqx=out:csv&sheet=Data_Anggota`;

    async function updateDashboard() {
        console.log("Mencoba mengambil data...");
        try {
            const res = await fetch(url + '&v=' + new Date().getTime());
            if (!res.ok) throw new Error("Gagal konek ke Google Sheets");
            
            const csv = await res.text();
            
            // Proses pembersihan CSV yang lebih tangguh
            const rows = csv.split('\n').map(r => {
                return r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
            });
            
            // FILTER: Hanya ambil baris yang kolom NAMANYA (Indeks 1) tidak kosong, 
            // bukan kata "NAMA", dan bukan "FALSE"
            const validData = rows.filter(r => 
                r[1] && 
                r[1] !== "" && 
                r[1].toUpperCase() !== "NAMA" && 
                r[1].toUpperCase() !== "NAMA ANGGOTA" &&
                r[1].toUpperCase() !== "FALSE"
            );

            console.log("Total baris valid ditemukan:", validData.length);

            if (validData.length > 0) {
                // KUNCINYA DI SINI: Ambil baris paling terakhir yang terisi
                const d = validData[validData.length - 1]; 
                
                console.log("Menampilkan Data Terbaru:", d[1]);

                // Update Tampilan
                document.getElementById('displayNama').innerText = d[1]; // Kolom B
                document.getElementById('displayKTA').innerText = "KTA: " + (d[0] || "-"); // Kolom A
                document.getElementById('displayJabatan').innerText = (d[3] && d[3] !== "FALSE") ? d[3] : "ANGGOTA"; // Kolom D

                // Logika Foto (Kolom C)
                let rawUrl = d[2] ? d[2].trim() : "";
                let finalFoto = "https://via.placeholder.com/300?text=FOTO+KOSONG";

                if (rawUrl.includes("drive.google.com")) {
                    let fileId = "";
                    if (rawUrl.includes("id=")) {
                        fileId = rawUrl.split('id=')[1].split('&')[0];
                    } else {
                        // Ambil ID dari link jenis /file/d/ID/view
                        let match = rawUrl.match(/\/d\/(.+?)\//);
                        fileId = match ? match[1] : (rawUrl.match(/[-\w]{25,}/) || [])[0];
                    }
                    
                    if (fileId) {
                        // Menggunakan thumbnail resolusi tinggi agar lebih cepat & muncul
                        finalFoto = `https://lh3.googleusercontent.com/d/${fileId}`;
                    }
                } else if (rawUrl.includes("http")) {
                    finalFoto = rawUrl;
                }

                document.getElementById('displayFoto').src = finalFoto;
                
            } else {
                console.warn("Tidak ada data valid untuk ditampilkan.");
            }
        } catch (e) {
            console.error("Waduh, Error Bos:", e.message);
        }
    }

    // Jalankan setiap 3 detik agar sangat responsif
    updateDashboard();
    setInterval(updateDashboard, 3000);
</script>
</body>
</html>
